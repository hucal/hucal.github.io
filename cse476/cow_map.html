<!doctype html>
<html class='no-js' lang='en'>
    <head>
        <meta charset='utf-8'>
        <meta http-equiv='X-UA-Compatible' content='IE=edge'>
        <title>D3 Map, COW Data</title>
        <meta name='description' content=''>
        <meta name='viewport' content='width=device-width, initial-scale=1'>

        <link rel='apple-touch-icon' href='../apple-touch-icon.png'>

        <link rel='stylesheet' href='../css/normalize.css'>
        <link rel='stylesheet' href='../css/main.css'>
        <script src='../js/vendor/modernizr-2.8.3.min.js'></script>
<style>

.feature {
  stroke: black;
  stroke-width: 0.5px;
}

.background {
    fill: white;
}


</style>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class='browserupgrade'>You are using an <strong>outdated</strong> browser. Please <a href='http://browsehappy.com/'>upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <p>Click Russia.</p>
        <p>Can change data sets, same as <a href=bilateral_sankey.html>this other draft vis</a></p>

<!---script src='http://d3js.org/d3.v3.min.js'></script--!>
<script src='lib/d3.v3.min.js'></script>
<script src='lib/topojson.v1.min.js'></script>
<script src='lib/colorbrewer.js'></script>
<script>

var flow1_color = d3.scale.ordinal().domain(d3.range(9)).range(colorbrewer.RdPu[9]);
var flow2_color = d3.scale.ordinal().domain(d3.range(9)).range(colorbrewer.PuBuGn[9]);
var neutral_color = 'white';
var highlight_color = 'black';

var width = 960,
    height = 1000;

var projection = d3.geo.conicEquidistant()
        .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection);

var min = 0.001, max_flow1 = min, max_flow2 = min, min_flow1 = min, min_flow2 = min;

function flow1_scale(f) { return Math.round((f - min_flow1) / (max_flow1 - min_flow1) * 8); }
function flow2_scale(f) { return Math.round((f - min_flow2) / (max_flow2 - min_flow2) * 8); }

function get_neutral_color (d) { return typeof(d.trade_info) === "undefined" ? neutral_color : flow2_color(flow2_scale(d.trade_info)); }

function get_flow1(d) { return (d.flow1 <= 0) ? get_neutral_color({trade_info:d}) : flow1_color(flow1_scale(d.flow1)); }
function get_flow2(d) { return (d.flow2 <= 0) ? get_neutral_color({trade_info:d}) : flow2_color(flow2_scale(d.flow2)); }

var scale_svg = d3.select('body').append('svg')
    .attr('width', 400)
    .attr('height', 50)
    .append('g')
    .attr('class', 'scale-reference');

function draw_scale(color_scheme) {
scale_svg.selectAll('.scale')
    .data(color_scheme.domain()).enter()
    .append('g')
    .attr('class', function(d, i) { return 'scale scale_' + i; })
    .attr('x', function(d, i) { return i * 50 + 10; })
    .attr('fill', function(d, i) { return color_scheme(i); })
    .attr('width', 30)
    .attr('height', 30);
}

var get_color = get_flow2;
draw_scale(flow2_color);
var svg = d3.select('body').append('svg')
    .attr('width', width)
    .attr('height', height);

var g = svg.append('g')
;
var g_links = svg.append('g')
    .attr('class', 'links')
;

g.append('rect')
    .attr('class', 'background')
    .attr('width', width)
    .attr('height', height);

// read query string, from Stackoverflow somewhere...
var queryString = {};
location.search.substr(1)
    .split('&').forEach(function(item)
            {queryString[item.split('=')[0]] = item.split('=')[1]});

var fname = queryString.fname;

if (queryString.fname === undefined)
    fname = '1950.json';

console.log('Reading data file data/' + fname);

d3.json('data/cshapes_q4.topo.json', function(error, topology) {
  g.selectAll('.feature')
      .data(topojson.feature(topology, topology.objects).features)
      .enter()
      .append('g')
      .attr('class', 'country')
      .append('path')
      .attr('d', path)
      .attr('class', function(d) { return 'feature ccode_' + d.properties.COWCODE; })
      .each(function(d) { d.highlighted = false; })
      .on('mouseover', function(d) {
           d3.select(this)
           .style('fill', highlight_color)
       })
       .on('mouseout', function(d) {
          if (d.highlighted) return;
           d3.select(this)
           .style('fill', get_neutral_color)
       })
       .each(function(d) {
           d3.select(this)
.append('svg:title')
       .text(d.properties.ISONAME + ', capital: ' + d.properties.CAPNAME)

       })
       ;
var seek_ccode_trade, trade_nodes;
    d3.json('data/' + fname, function(error, trade) {
        trade_nodes = trade;
        seek_ccode_trade = trade.nodes.map(function(n) {
            // find max flow1, flow2
            n.links.forEach(function(l) {
            l.flow1 = +l.flow1; l.flow2 = +l.flow2;
            if (l.flow1 > max_flow1) max_flow1 = l.flow1;
            if (l.flow2 > max_flow2) max_flow2 = l.flow2;

            if (l.flow1 < min_flow1 && n.flow1 > 0) min_flow1 = l.flow1;
            if (l.flow2 < min_flow2 && n.flow2 > 0) min_flow2 = l.flow2;
            });
            n.ccode1 = parseInt(n.ccode1);
            return parseInt(n.ccode1); });
            ;


        g.selectAll('g.country')
        .each(function(d) {

            var node_ix = seek_ccode_trade.indexOf(d.properties.COWCODE);
            if (node_ix < 0) {
                console.log(d.properties.ISONAME + ' not found in trade data nodes');
                return;
            }
            d.trade_info = trade.nodes[node_ix];
            d.trade_info_on = false;
            d3.select(this).on('click', toggle_trade_info)
                .style('fill', get_neutral_color);
        });
    });
});

// hover on links? crank up opacity!
function toggle_trade_info(d) {
    d3.select(this).each(function (_) {
        var d_elem = d3.select(this);

        d.highlighted = !d.highlighted;
        d3.selectAll('.feature').filter(function(e){return e.properties.COWCODE !== d.properties.COWCODE;}).style('display', 'none')
        if (!d.highlighted) d3.selectAll('.feature').style('display', 'inline')
        d.trade_info.links.forEach(function (other) {
            if (other.flow2 <= 0) return;
              d3.select('.ccode_' + other.ccode2)
                  .style('display', 'inline')
                  .style('fill', d.highlighted ? function(d) {
                    return get_color(other);
                  } : get_neutral_color({trade_info:other}))
              ;

        });
    })
    ;
}

</script>
</body>
</html>

