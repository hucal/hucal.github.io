<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="../css/normalize.css">
        <link rel="stylesheet" href="../css/main.css">
        <script src="../js/vendor/modernizr-2.8.3.min.js"></script>
        <style>
.link {
    fill: none;
    stroke-opacity: 0.7;
}
        </style>
     </head>

<body>
<!--[if lt IE 8]>
<p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->

    <!--div id="select-sort" class="dropdown"> <form><select>
    </select></form></div--!>

    <p>D3 visualization of
    <a href="http://www.correlatesofwar.org/COW2%20Data/Trade/Trade.html">dyadic trade data</a>
    from various years.</p>
    <p>Use the URL's query string to change years. Will add a nicer timeline, and a more complete dataset soon.</p>
    <p><a href=bilateral_sankey.html?fname=1870.json>1870.json</a>
    <a href=bilateral_sankey.html?fname=1950.json>1950.json</a>
    <a href=bilateral_sankey.html?fname=2009.json>2009.json</a></p>
    <div id="vis"></div>
<script src='lib/jquery-1.11.2.min.js'></script>
<script src='lib/d3.v3.js'></script>
<script src='lib/sankey.js'></script>
<script>

var margin = {top: 10, right: 150, bottom: 10, left: 150},
    width = 900 - margin.left - margin.right,
    height = 9000 - margin.top - margin.bottom;

var  color = d3.scale.category20();

// append the svg canvas to the page
var svg = d3.select("div#vis").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

var sankey = d3.sankey()
    .nodeWidth(80)
    .nodePadding(20)
    .size([width, height]);

var path = sankey.link();

var format_money = d3.format(",.3f")

var queryString = {};

// read query string, from Stackoverflow somewhere...
location.search.substr(1)
    .split("&").forEach(function(item)
            {queryString[item.split("=")[0]] = item.split("=")[1]});

var fname = queryString.fname;

if (queryString.fname === undefined)
    fname = "1950.json";

console.log("Reading data file data/" + fname)

d3.json('data/' + fname, function(error, trade_data) {
    if (error) {
        console.log(error);
        return;
    }
    var data = trade_data.nodes;
    data.forEach(function (d) {
        d.name = d.links[0].importer1;
        d.ccode1 = +d.ccode1;
        d.links.forEach(function(e) {
            e.ccode2 = +e.ccode2; e.flow1 = +e.flow1, e.flow2 = +e.flow2;
            if (e.flow1 < 0.0001) e.flow1 = 0.0001;
            if (e.flow2 < 0.0001) e.flow2 = 0.0001;
        })
        d.targetLinks = [];
        d.sourceLinks = [];
        d.selected = false;
    });

    graph = {
        links: [], nodes_left: data, nodes_right: $.extend(true, [], data)
    };

    // index nodes by their ccode
    by_ccode = [];
    data.forEach(function(d, i) {
        d.value = 40;
        by_ccode.push(d.ccode1);
    });

    var obj_wtf = {name: "WTF", targetLinks: [], sourceLinks: [], flow1:-9, flow2:-9};
    graph.nodes_left.forEach(function (d) {
        d.links.forEach(function (child) {
            var child_obj = graph.nodes_right[by_ccode.indexOf(child.ccode2)];
            if (child_obj === undefined) child_obj = obj_wtf;
            var l2 = {
                source: d,
                target: child_obj,
                value: child.flow1
            };
            var l1 = {
                source: child_obj,
                target: d,
                value: child.flow2
            };
            d.sourceLinks.push(l1);
            child_obj.targetLinks.push(l1);
            graph.links.push(l1);

            child_obj.links = undefined;
        });
        d.links = undefined;
    });

    graph.nodes = graph.nodes_left.concat(graph.nodes_right);
    graph.nodes.sort(total_asc)

    console.log(graph);

    update(graph);

    function alphabetic_sort(a, b) { return a.name.localeCompare(b.name); }
    function total_dsc(a, b) {return d3.descending(a.flow2_total + a.flow1_total,
                                                  b.flow2_total + b.flow1_total); }
    function total_asc(a, b) {return d3.ascending(a.flow2_total + a.flow1_total,
                                                  b.flow2_total + b.flow1_total); }

    /*
    setTimeout(function() {
    data.sort(total_dsc);
    update(data);
    }, 2000)

    setInterval(function() {
        var ix = Math.floor(Math.random() * data.length)
            t = data[ix];
        data[ix] = data[data.length - 1 - ix];
        data[data.length - 1 - ix] = t


        update(data);
    }, 5000);
    */
});


function update(graph) {
// Set the sankey diagram properties

// load the data
  sankey
      .nodes(graph.nodes)
      .links(graph.links)
      .layout(200);

// add in the links
  var link = svg.append("g").selectAll(".link")
      .data(graph.links)
    .enter().append("path")
    .attr("class", function(d) {
        return "link link_to_" + d.target.name.replace(/ /g, "_")
             + " link_from_" + d.source.name.replace(/ /g, "_");
    })
      .attr("d", path)
      .attr("stroke", "none")//function (d) {
//		  return color(d.source.name.replace(/ .*/, "")); })
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .sort(function(a, b) { return b.dy - a.dy; });

// add the link titles
//  link.append("title");

// add in the nodes
  var node = svg.append("g").selectAll(".node")
      .data(graph.nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) {
		  return "translate(" + d.x + "," + d.y + ")"; })
    .call(d3.behavior.drag()
      .origin(function(d) { return d; })
      .on("dragstart", function() {
		  this.parentNode.appendChild(this); })
      .on("drag", dragmove))
      .on("click", function(d) {
        d.selected = !d.selected;
        d3.selectAll(".link_to_" + d.name.replace(/ /g, "_"))
            .attr("stroke", d.selected ? d.color : "none");
      })
    ;
    node.filter(function(d) { return d.x < width / 2; })
      .on("click", function(d) {
        d.selected = !d.selected;
        d3.selectAll(".link_from_" + d.name.replace(/ /g, "_"))
            .attr("stroke", d.selected ? d.color : "none");
      })

// add the rectangles for the nodes
  node.append("rect")
      .attr("height", function(d) { return d.dy + 1; })
      .attr("width", sankey.nodeWidth())
      .style("fill", function(d) {
		  return d.color = color(d.name.replace(/ .*/, "")); })
      .style("stroke", function(d) {
		  return d3.rgb(d.color).darker(2); });

// add in the title for the nodes
  node.append("text")
      .attr("x", 6 + sankey.nodeWidth())
      .attr("y", function(d) { return d.dy / 2; })
      .attr("dy", ".35em")
      .attr("text-anchor", "start")
      .attr("transform", null)
      .text(function(d) { return d.name; })
    .filter(function(d) { return d.x < width / 2; })
      .attr("x", -6)
      .attr("text-anchor", "end");

  console.log(graph);

// the function for moving the nodes
  function dragmove(d) {
    d3.select(this).attr("transform",
        "translate(" + d.x + "," + (
                d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
            ) + ")");
    sankey.relayout();
    link.attr("d", path);
  }




}


</script>
</body>
</html>
